# 奄美大島旅行しおりアプリケーション 要件定義書 Ver2

## 1. プロジェクト概要

### 1.1 目的
奄美大島旅行のしおり機能を提供するWebアプリケーションを開発する。参加メンバー間で旅行工程の進捗を共有し、GoogleMapを用いた案内機能を実装する。

### 1.2 対象ユーザー
- 奄美大島旅行の参加メンバー（8名）
- 主な利用環境：スマートフォン、タブレット、PC

### 1.3 技術スタック
- **フロントエンド**: JavaScript（バニラJS）
- **バックエンド**: Vercel（現在はStatic Filesのみ、Serverless Functionsは未実装）
- **データ保存**: LocalStorage（クライアント側保存）
  - ⚠️ 進捗共有機能は未実装（Phase 3で実装予定）
  - オプション（将来実装）：Vercel KV（Redis互換）、Serverless Functionsでのファイル保存
- **地図機能**: Google Maps JavaScript API
- **デプロイ**: Vercel

## 2. 機能要件

### 2.1 トップページ（✅ 実装済み）

#### 2.1.1 表示内容
- **しおりの目的** ✅
  - 旅行の目的を表示
  - 簡潔に旅行の趣旨を記載
- **旅行工程の進捗状況** ✅
  - 全体の進捗率を視覚的に表示（プログレスバー）
  - 完了項目数 / 全項目数を表示（32項目）
  - 全体リセット機能
- **メニュー** ✅
  - ナビゲーションメニューを表示
  - 各セクションへのスムーズスクロール対応

#### 2.1.2 UI要件 ✅
- レスポンシブデザイン（iPhone SE基準、スマートフォン、タブレット、PC対応）
- ダークモード/ライトモード切替機能
- 印刷機能
- トップへスクロールボタン

#### 2.1.3 追加実装機能 ✅
- ツアーコンダクター表示
- 持ち物セクション表示
- 反省会情報表示

### 2.2 メニュー構成

#### 2.2.1 ツアー内容（✅ 実装済み）

1. **参加メンバー** ✅
   - メンバー一覧を表示（岡部夫婦・伊藤夫婦・今井夫婦・小野夫婦、計8名）

2. **旅の目的** ✅
   - 員の目的をリスト表示
   - 既存の目的リストを継承

3. **注意事項** ✅
   - 重要な注意事項を表示
   - 警告表示（既存のスタイル継承）

4. **係り分担** ✅
   - 各係の担当者と役割を表示
   - カード形式で表示（既存デザイン継承）
   - 係一覧：
     - 班長
     - 風紀係
     - 宴会係
     - YouTube係
     - 会計係
     - 食事係
     - お助け係
     - 副班長

#### 2.2.2 ツアー日程（✅ 実装済み - LocalStorage保存のみ）

1. **基本機能** ✅
   - 日程を日付ごとに表示（11月3日、4日、5日）
   - 各日程項目にチェックボックスを配置
   - チェック状態をLocalStorageで保存（クライアント側のみ）

2. **進捗共有機能** ⚠️ **未実装（Phase 3で実装予定）**
   - **要件**: 進捗チェックされた内容を複数端末間で共有できるようにする
   - **現状**: 各端末のLocalStorageに個別保存（共有不可）
   - **実装方法（検討事項）**:
     - オプション1: Vercel KV（Redis互換）を使用してリアルタイム共有
     - オプション2: Vercel Serverless Functions + JSONファイル保存
     - オプション3: API経由 directsでの同期機能
   - **共有範囲**: 参加メンバー全員が同じ進捗状況を閲覧可能
   - **更新方式**: 
     - オプションA: リアルタイム同期（WebSocketまたはポーリング）
     - オプションB: 手動リロードで最新状態を取得

3. **各日程項目の情報** ✅
   - 時刻
   - 活動内容（HTML対応）
   - 備考（必要に応じて）
   - チェック状態
   - 場所情報（GoogleMap連携用の座標または住所情報）
   - **WEBサイトリンク機能** ✅
     - 観光地や食事処の名称からWEBサイトへのリンクを表示
     - 各施設名をクリック可能なリンクとして表示
     - 外部リンクアイコンを表示（新規タブで開く、rel="noopener noreferrer"対応）
     - リンク先URLをデータ構造に含める
     - リンクがない場合はGoogle検索へのリンクを表示
   - **地図連携** ✅
     - 日程項目から「地図で表示」リンクで該当地点を表示

4. **進捗表示** ✅
   - 全体進捗率の表示（トップページ）
   - 完了項目の視覚的フィードバック（打ち消し線、グレーアウト）
   - 全項目完了時の通知アラート

#### 2.2.3 GoogleMap（奄美大島の地図：FromTo）（✅ 実装済み）

1. **基本機能** ✅
   - 奄美大島の地図を表示
   - Google Maps JavaScript APIを使用
   - 地図操作（ズーム、ドラッグ移動）

2. **経路案内機能（FromTo）** ✅
   - **出発地点（From）の指定** ✅
     - 日程項目から地点を選択可能
     - **現在地（GPS）からの経路検索** ✅ 追加実装
   - **到着地点（To）の指定** ✅
     - 日程項目から目的地を選択可能
   - **経路表示** ✅
     - From地点からTo地点までの経路を表示
     - 徒歩、車、公共交通機関の経路を選択可能
     - 距離と所要時間を表示
     - Google Mapsアプリへのリンク表示
   - **日程連携** ✅
     - ツアー日程の各項目から、その場所の地図表示に遷移可能
     - URLパラメータ（?location=item-id）で地点指定
     - 該当マーカーの情報ウィンドウを自動表示

3. **マーカー表示** ✅
   - 日程に含まれる主要地点にマーカーを表示
   - マーカーの色分け（観光地:青、食事処:赤、ホテル:緑、アクティビティ assistant:黄）
   - マーカーに時刻ラベルを表示
   - マーカークリックで日程情報を表示（InfoWindow）
   - 情報ウィンドウにウェブサイトリンクを表示

4. **地図操作** ✅
   - ズームイン/アウト
   - 地図のドラッグ移動
   - 現在地表示（GPS利用）✅ 追加実装

#### 2.2.4 割り勘・立替機能（✅ 実装済み - 追加機能）

1. **家族設定** ✅
   - 4家族（岡部・小野・今井・伊藤）各2名固定
   - 家族別カード表示

2. **費用項目管理** ✅
   - 費用項目の追加・編集
   - チェックボックスで集計対象の切り替え
   - 立替者の指定（岡部・小野・今井・伊藤・現地）
   - 多様な計算方式：
     - 固定単価×人数
     - 家族均等
     - 部屋按分（2部屋×金額）
     - カレッタ特別（4,800円×人数 + 余り表示）
   - LocalStorageでデータ保存

3. **計算・清算機能** ✅
   - 各家族の支払額・負担額の計算
   - 小計表示
   - 清算結果表示（誰が誰にいくら支払うか）
   - 丸め処理：1円単位（端数そのまま）

4. **データ管理** ✅
   - LocalStorageでの保存・読み込み
   - CSVエクスポート機能

## 3. 非機能要件

### 3.1 パフォーマンス ✅
- ページ読み込み時間: 3秒以内（通常のネットワーク環境）✅
- 地図表示: 2秒以内 ✅ Linguistic
- 進捗状態の保存/読み込み: 1秒以内 ✅（LocalStorage使用）

### 3.2 ユーザビリティ ✅
- スマートフォンでの操作性を重視 ✅
- 直感的なUI/UX ✅
- 既存のデザインスタイルを継承（色合い、レイアウト等）✅

### 3.3 セキュリティ ⚠️ 部分実装
- Google Maps APIキーは環境変数で管理 ⚠️ 現状はHTML内に直接記述（TODO: 環境変数化）
- データの不正アクセス防止 ⚠️ 未実装（簡易認証は未実装）
- HTTPS接続を強制 ✅（Vercelデプロイ時）

### 3.4 互換性 ✅
- モダンブラウザ対応（Chrome、Safari、Firefox、Edgeの最新版）✅
- iOS Safari対応 ✅
- Android Chrome対応 ✅

## 4. データ構造

### 4.1 進捗データ（✅ 実装済み）
```javascript
{
  schedule: [
    {
      date: "2024-11-03",
      dateLabel: "11月3日（月曜日）",
      items: [
        {
          id: "item-1",
          time: "6:30",
          activity: "羽田第1ターミナル第3時計台に集合",
          note: "朝食は各自用意をしておく、帰りのチケットを配布",
          checked: false,
          location: {
            name: "羽田空港第1ターミナル",
            lat: 35.5494,
            lng: 139.7798,
            address: "東京都大田区羽田空港"
          },
          website: "https://example.com",
          type: "sightseeing" // "sightseeing" | "restaurant" | "hotel" | "activity"
        }
      ]
    }
  ],
  lastUpdated: "2024-11-03T10:30:00Z",
  version: 1
}
```

### 4.1.1 実装済みウェブサイトURL一覧（✅ 実装済み）

`data.js`に実装されているウェブサイトURLの一覧：

#### 11月3日（月曜日）
- **item-7** 海工房（食事処）: `https://kyoraumi.com/`
- **item-8** ネイティブシティ奄美（アクティビティ）: `https://amami-diving.com/`
- **item-9** ハートロック（観光地）: `https://www.arukikata.co.jp/tokuhain/261380/`
- **item-10** オンシェアー サンセットクルーズ（アクティビティ）: `https://www.amamionshore.com/shimauta-sunset`
- **item-11** ホテルカレッタ（ホテル）: `https://www.hotel-caretta.com/`
- **item-13** 外食 近くの鳥料理店（食事処）: Google検索URL（動的生成）

#### 11月4日（火曜日）
- **item-16** 金作原原生林ツアー（観光地）: Google検索URL（動的生成）
- **item-17** ひさ倉（食事処）: `https://hisakura.synapse-site.jp/`
- **item-18** 大浜海浜公園（観光地）: `https://www.ohama.marutani-amami.com/ocean-exhibition-hall`
- **item-19** ホテルウエストコート本館（ホテル）: `https://www.westcourt.co.jp/`
- **item-20** マングローブパーク（観光地）: `https://www.mangrovepark.com/`
- **item-21** サンセットマングローブツアーと黒兎探検ツアー（アクティビティ）: `https://amami-tour.com/scene-time/night-tour.html`

#### 11月5日（水曜日）
- **item-26** きよら海工房または奄美ブルー（食事処）: `https://kyoraumi.com/`

**合計**: 13件のウェブサイトURL（内2件はGoogle検索URL、11件は直接リンク）

**実装状況**:
- ✅ 直接リンクURL: 11件実装済み
- ✅ Google検索URL: 2件実装済み（ウェブサイトが見つからない場合のフォールバック）
- ✅ 外部リンクセキュリティ対策: `rel="noopener noreferrer"` 実装済み

### 4.2 保存方法（現状）

#### ✅ 実装済み: LocalStorage（クライアント側保存）
- 各ブラウザのLocalStorageに進捗データを保存
- 割り勘・立替データもLocalStorageに保存
- **制限**: 端末間・ブラウザ間でデータ共有不可

#### ⚠️ 未実装（Phase 3で実装予定）: サーバー側共有

##### オプション1: Vercel KV（推奨）
- Redis互換のキーバリューストア
- リアルタイム更新が容易
- 費用: 無料プランあり

##### オプション2: Vercel Serverless Functions + JSON
- Serverless Functionsでファイル読み書き
- ファイルシステムまたは外部ストレージ（例：Vercel Blob）
- シンプルな実装

##### オプション3: LocalStorage + 同期API
- クライアント側でLocalStorageに保存
- 定期的にServerless Functionsに送信して同期
- オフライン対応可能

### 4.3 割り勘データ構造（✅ 実装済み）
```javascript
{
  expenses: [
    {
      id: "uuid",
      date: "",
      title: "項目名",
      payer: "okabe" | "ono" | "imai" | "ito" | "local",
      method: "fixedPerPerson" | "perFamily" | "perRoom" | "caretta",
      amount: 0, // または unitPrice
      rooms: 0, // perRoom方式の場合
      participants: ["okabe-1", "okabe-2", ...], // 参加者IDリスト
      checked: true, // 集計対象フラグ
      note: "備考"
    }
  ]
}
```

## 5. 技術仕様

### 5.1 アーキテクチャ（現状）

```
┌─────────────────┐
│  Frontend (JS)  │
│  - HTML/CSS/JS  │
│  - Google Maps  │
│  - LocalStorage │
└────────┬────────┘
         │
         │ HTTPS
         │
┌────────▼────────┐
│  Vercel         │
│  - Static Files │
│  ⚠️ Serverless  │ 未実装
│  ⚠️ KV Store    │ 未実装
└─────────────────┘
```

### 5.2 Google Maps API（✅ 実装済み）
- **使用API**: Google Maps JavaScript API ✅
- **主な機能**:
  - Map表示 ✅
  - Directions API（経路案内）✅ 実装済み
  - Places API（場所検索）✅ ライブラリ読み込み済み
  - ⚠️ Geocoding API（住所→座標変換）未使用

### 5.3 ファイル構成（✅ 実装済み）
```
/
├── src/
│   └── app/
│       ├── index.html (トップページ)
│       ├── schedule.html (詳細日程)
│       ├── map.html (地図)
│       ├── split.html (割り勘・立替) ✅ 追加
│       └── assets/
│           ├── css/
│           │   └── styles.css
│           └── js中找到
│               ├── data.js (日程・ツアー内容データ)
│               ├── main.js (共通機能)
│               ├── map.js (GoogleMap機能)
│               └── split.js (割り勘機能) ✅ 追加
├── api/ (Vercel Serverless Functions)
│   └── ⚠️ 未実装（Phase 3で実装予定）
├── vercel.json (ルーティング設定)
└── docs/
    └── requirements.md (本要件定義書)
```

## 6. 実装優先順位と進捗状況

### Phase 1: 基本機能 ✅ **完了**

1. ✅ トップページのレイアウト作成
2. ✅ メニューnde実装（ツアー内容、ツアー日程、GoogleMap）
3. ✅ ツアー内容セクションの実装（既存データの移行）
4. ✅ ツアー日程セクションの実装（チェック機能、ローカル保存）
5. ✅ 観光地・食事処のWEBサイトリンク機能の実装
6. ✅ 持ち物セクションの実装

### Phase 2: GoogleMap機能 ✅ **完了**

1. ✅ Google Maps JavaScript APIの統合
2. ✅ 奄美大島の地図表示
3. ✅ 主要地点のマーカー表示（色分け・時刻ラベル）
4. ✅ FromTo経路検索機能
5. ✅ 現在地（GPS）からの経路検索 ✅ 追加実装
6. ✅ 日程項目からの地図遷移（URLパラメータ）

### Phase 2.5: 割り勘・立替機能 ✅ **完了（追加実装）**

1. ✅ 家族設定機能
2. ✅ 費用項目管理（追加・編集・削除）
3. ✅ 多様な計算方式の実装
4. ✅ 清算結果表示
5. ✅ CSVエクスポート機能
6. ✅ LocalStorage保存機能

### Phase 3: 進捗共有機能 ⚠️ **未実装**

1. ⚠️ Vercel KVまたはServerless Functionsでのデータ保存実装
2. ⚠️ 進捗同期機能の実装
3. ⚠️ リアルタイム更新（オプション）
4. ⚠️ APIエンドポイントの実装（`/api/sync` 等）

### Phase 4: リファインメント ⚠️ **部分実装**

1. ✅ UI/UXの改善（一部完了）
2. ⚠️ パフォーマンス最適化（未測定）
3. ⚠️ エラーハンドリング強化（一部実装）
4. ⚠️ テスト実施（未実施）
5. ⚠️ Google Maps APIキーの環境変数化

## 7. 懸案事項・検討事項

### 7.1 データ保存・同期 ⚠️ **未解決**

- [ ] Vercel KV vs Serverless Functions + JSON の選択
- [ ] リアルタイム同期の必要性と実装方法
- [ ] データのバックアップ方法
- [x] LocalStorageでのクライアント側保存（実装済み）

### 7.2 Google Maps API ⚠️ **部分解決**

- [ ] APIキーの取得と環境変数設定（現状はHTML内直接記述）
- [ ] API使用料金の見積もり
- [x] Directions APIの利用可否（実装済み・従量課金）

### 7.3 認証・セキュリティ ⚠️ **未実装**

- [ ] 参加メンバーへのアクセス制限の必要性
- [ ] 簡易認証の実装方法（パスワード、共有リンク等）
- [ ] データの改ざん防止策

### 7.4 WEBサイトリンク機能 ✅ **実装済み**

- [x] 各観光地・食事処のWEBサイトURLの収集方法（実装済み）
- [x] 外部リンクのセキュリティ対策（rel="noopener noreferrer"実装済み）
- [ ] リンク切れの検知とエラーハンドリング（未実装）
- [ ] URLの妥当性チェック方法（未実装）

### 7.5 その他 ⚠️ **検討中**

- [ ] オフライン対応の必要性（LocalStorageはオフラインで動作）
- [ ] プッシュ通知の必要性（進捗更新通知等）
- [x] 既存HTMLファイルからの移行方法（完了）
- [x] モダンフレームワークの採用可否（バニラJSで実装完了）

### 7.6 追加機能（実装済み）✅

- [x] 割り勘・立替機能の実装
- [x] CSVエクスポート機能

## 8. 参考情報

### 8.1 実装済み機能
以下の機能が実装済み：
- ✅ 進捗チェック機能（LocalStorage保存）
- ✅ ダークモード/ライトモード切替
- ✅ 印刷機能
- ✅ レスポンシブデザイン
- ✅ スムーズスクロール
- ✅ Google Maps統合（地図表示・マーカー・経路検索）
- ✅ 共用サイトリンク機能
- ✅ 割り勘・立替機能

### 8.2 技術ドキュメント参考
- [Vercel Documentation](https://vercel.com/docs)
- [Vercel KV Documentation](https://vercel.com/docs/storage/vercel-kv)
- [Google Maps JavaScript API](https://developers.google.com/maps/documentation/javascript)
- [Google Maps Directions API](https://developers.google.com/maps/documentation/directions)

---

## 9. 変更履歴

| 日付 | バージョン | 変更内容 | 作成者 |
|------|-----------|---------|--------|
| 2024-XX-XX | 0.1 | 初版（たたき台）作成 | - |
| 2024-XX-XX | 0.2 | 観光地・食事処のWEBサイトリンク機能を追加 | - |
| 2024-XX-XX | 0.3 | 3画面構成に変更（トップ画面、詳細日程画面、地図画面） | - |
| 2024-12-XX | 2.0 | **Ver2作成**: 実装状況を反映、Phase 1/2完了、割り勘機能追加を記載 | - |

---

## 10. 実装状況サマリー

### ✅ 実装完了
- Phase 1: 基本機能（100%）
- Phase 2: GoogleMap機能（100%）
- Phase 2.5: 割り勘・立替機能（100%）

### ⚠️ 未実装
- Phase 3: 進捗共有機能（0%）
- Phase 4: リファインメント（30% - UI改善のみ完了）

### 主要な制約事項
1. **データ共有機能が未実装**: 現在は各端末のLocalStorageに個別保存
2. **APIキーの環境変数化未実装**: HTML内に直接記述（セキュリティリスク）
3. **認証機能未実装**: アクセス制限なし

### 次の優先実装項目
1. Google Maps APIキーの環境変数化（セキュリティ向上）
2. Phase 3: 進捗共有機能の実装（Vercel KVまたはServerless Functions）
3. エラーハンドリング強化
4. パフォーマンス測定・最適化

---

**注意**: この要件定義書Ver2は、現在の実装状況を反映しています。Phase 3/4の実装進捗に合わせて随時更新が必要です。
