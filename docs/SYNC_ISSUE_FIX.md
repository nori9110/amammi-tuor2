# PCとスマホ間のチェックボックス同期問題 - 原因と対策

## 🔍 問題の原因

PCとスマホでチェックボックスの反映が連携していなかった原因は以下の通りです：

### 1. ポーリング間隔が長すぎる
- **問題**: ポーリング間隔が30秒と長く、他の端末の変更を検知するまで最大30秒かかっていた
- **影響**: リアルタイム性が低く、ユーザー体験が悪い

### 2. 日程ページにポーリング機能がない
- **問題**: `ProgressSection`コンポーネントには30秒ごとのポーリングがあったが、`SchedulePage`には実装されていなかった
- **影響**: 日程ページで他の端末の変更を検知できない

### 3. ページフォーカス時の更新がない
- **問題**: ブラウザタブを切り替えて戻ってきた時や、ページが表示された時に最新データを取得していなかった
- **影響**: 他の端末で変更があった後、ページに戻っても最新データが表示されない

### 4. データ変更検知の不備
- **問題**: `lastUpdated`タイムスタンプを比較して変更を検知する仕組みが不十分だった
- **影響**: 不必要な更新が発生したり、必要な更新が検知されない可能性があった

## ✅ 実装した対策

### 1. ポーリング間隔の短縮
- **変更**: 30秒 → **5秒**に短縮
- **効果**: 他の端末の変更を最大5秒以内に検知可能
- **実装場所**: 
  - `src/app/schedule/page.tsx`
  - `src/components/progress/ProgressSection.tsx`

### 2. 日程ページへのポーリング機能追加
- **変更**: `SchedulePage`に5秒ごとのポーリング機能を追加
- **効果**: 日程ページでも他の端末の変更を検知可能
- **実装場所**: `src/app/schedule/page.tsx`

### 3. ページフォーカス・表示時の自動同期
- **追加機能**:
  - `visibilitychange`イベント: ページが表示された時に最新データを取得
  - `focus`イベント: ウィンドウがフォーカスされた時に最新データを取得
- **効果**: タブを切り替えて戻ってきた時や、ページを表示した時に自動的に最新データを取得
- **実装場所**: 
  - `src/app/schedule/page.tsx`
  - `src/components/progress/ProgressSection.tsx`

### 4. データ変更検知の改善
- **変更**: `useRef`を使用して`lastUpdated`タイムスタンプを追跡
- **効果**: 不要な更新を避け、変更があった時のみ状態を更新

## 📊 同期の仕組み

### データフロー
```
1. ユーザーがチェックボックスをクリック（端末A）
   ↓
2. LocalStorageに即座に保存（楽観的更新）
   ↓
3. API `/api/schedule/check` に送信
   ↓
4. Vercel KVに保存
   ↓
5. 他の端末（端末B）のポーリング（5秒ごと）が変更を検知
   ↓
6. API `/api/schedule` から最新データを取得
   ↓
7. LocalStorageに保存し、UIを更新
```

### 同期タイミング

1. **即座の同期**
   - チェックボックス操作後、すぐにAPIに送信

2. **定期的な同期（ポーリング）**
   - 5秒ごとに最新データを取得
   - 変更があれば自動更新

3. **イベントベースの同期**
   - ページ表示時（`visibilitychange`）
   - ウィンドウフォーカス時（`focus`）
   - 同タブ内の変更（`schedule-updated`イベント）
   - 他のタブからの変更（`storage`イベント）

## 🎯 期待される動作

### 動作例
1. **PCでチェック**: PCでチェックボックスをクリック
2. **即座に反映**: PCでは即座にチェック状態が反映
3. **5秒以内にスマホへ同期**: スマホでは最大5秒以内に自動的にチェック状態が反映
4. **逆方向も同様**: スマホでチェックした場合も、PCに最大5秒以内に反映

### 同期速度
- **最速**: ポーリングのタイミング次第で0〜5秒
- **平均**: 約2.5秒
- **最長**: 5秒（次回ポーリング時）

## 🔧 技術的な詳細

### 実装した機能

1. **ポーリング機能**
   ```typescript
   setInterval(async () => {
     const latest = await loadScheduleData();
     if (latest.lastUpdated !== lastUpdatedRef.current) {
       setScheduleData(latest);
     }
   }, 5000); // 5秒ごと
   ```

2. **ページ可視性の検知**
   ```typescript
   document.addEventListener('visibilitychange', async () => {
     if (document.visibilityState === 'visible') {
       const latest = await loadScheduleData();
       setScheduleData(latest);
     }
   });
   ```

3. **フォーカス時の同期**
   ```typescript
   window.addEventListener('focus', async () => {
     const latest = await loadScheduleData();
     setScheduleData(latest);
   });
   ```

## 📝 今後の改善案

### よりリアルタイムな同期
- **WebSocket**: リアルタイム同期（実装コストが高い）
- **Server-Sent Events (SSE)**: サーバーからのプッシュ通知
- **短いポーリング間隔**: 現在5秒をさらに短く（ただし、API負荷が増加）

### バッテリー消費の最適化
- **バックグラウンドポーリングの制御**: ページが非表示の時はポーリングを停止
- **ネットワーク状態の検知**: オフライン時はポーリングを停止

## 🔄 テスト方法

### 同期動作の確認
1. PCとスマホで同じURLにアクセス
2. PCでチェックボックスをクリック
3. スマホで5秒以内にチェック状態が反映されることを確認
4. 逆方向も同様に確認

### ポーリングの確認
1. ブラウザの開発者ツールのNetworkタブを開く
2. 5秒ごとに`/api/schedule`へのGETリクエストが発生することを確認

---

**修正日**: 2024-12-XX  
**修正者**: AI Assistant  
**状態**: ✅ 実装完了・デプロイ済み

